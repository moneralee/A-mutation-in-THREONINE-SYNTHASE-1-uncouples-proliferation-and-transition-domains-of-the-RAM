#A mutation in THREONINE SYNTHASE 1 uncouples proliferation and transition domains of the root apical meristem
# Monica L. Garcia-Gomez, Blanca Jazmin Reyes-Hernandez, Debee Prasad Sahoo, Selene Napsucialy-Mendivil,
# Aranza Xhaly Quintana-Armas, Jose Antonio Pedroza-Garcia, Svetlana Shishkova, Hector Hugo Torres-Martinez,
# Mario A. Pacheco-Escobedo, and Joseph G. Dubrovsky, 2022
#####################################################################################################
# This code simulates an in silico growing root, where cell divisions in the RAM (PD) are dependent  
# on Thr-catabolic products (i.e. Gly and Ile). The model simulates the expression of TS1, TSY2, OMR1 and 
# THA1/2 in each cell, and the Thr, Gly and Ile (derived from Thr catabolism) produced in each cell. This 
# is then used as a condition to decide if cells at the RAM (PD) divide or not.

#Code generated by Monica L Garcia-Gomez
#--> Instructions: First run "Threonine-model-Functions-catabolism.R", and then this code. 

#What field do you want to plot? cells or THR?
fieldname<-"cells"
#These are the simulations this code can perform
files<-c("WT","mto22")#,"double mutant","ts2")
dir.create("output")
Dv<-3
El<-6
Df<-80
for(h in 1:length(files)){
  simul<- files[h]
  dir.create(paste("output/",simul,sep=""))
  #########################Initial condition###############
  elong<-6 
  simulationTimegrowthdivision<-1  
  #Parameteres for Thr equation
  thetats1<-5
  thetatha<-5
  thetaomr1<-5
  thetaile<-5
  if((simul=="mto22") | (simul=="double mutant")){
    thetats2<-5
  }else{  
    thetats2<-500
  }
  umbralRAM<-5 #Ile+Gly
  kdecay<-0.1
  x<-90
  y<-355
  coordenadas<-initialcondition("initial_condition/initialcondition.csv",x,y,100000,21)
  id<-importid("initial_condition/initialcondition.csv")
  coordColors<-readRDS("initial_condition/cells.rds")
  coordColorsTS1<-0
  coordColorsTS2<-0
  coordColorsTHR<-0
  simulationTime<-250 
  ########################################################################### SIMULATION ###########################################################################
  for(t in 1:simulationTime){
    #########################################GROWTH DYNAMICS########################################
    #1.-Define if cells growth(0),divide(1),no change and no displacement(2),elongate(3),differentiate(5),or no change but can be displaced (4). etc. Calculate cell displacements due to growth in below cells. 
    for(i in 1:id){ 
      simulhelper<-coordenadas[i,18]+coordenadas[i,20]   #to integrate Thr-catabolism products into the division decision (Gly+Ile).  
      helper<-coordenadas[i,3]-coordenadas[i,2]  #cell length
      coordenadas[i,9]<-(helper-1)/2    #to check that divisions will be symmetrical (cells of same length)
      if(helper>Df){  #cells differentiate once they reach a certain length
        coordenadas[i,6]<-5
      }else if(coordenadas[i,7]>4){         #These are either stem cells or columella. Only proximal initials divide
        if(mod(t,simulationTimegrowthdivision*3)==0){
          if(coordenadas[i,2]==29){
            if( (helper>=Dv) & (mod(helper,2)!=0) & (simulhelper>umbralRAM)){
              coordenadas[i,6]<-1
            }else{coordenadas[i,6]<-0}
          }else{coordenadas[i,6]<-2} 
        }else{coordenadas[i,6]<-2}
      }else if((coordenadas[i,3]>355) | coordenadas[i,6]==5 ){    #Cell differentiation defined by distance from QC
        coordenadas[i,6]<-5
      }else if((coordenadas[i,3]>160) | (coordenadas[i,6]==3)){    #Cell elongation defined by distance from QC
        coordenadas[i,6]<-3
      }else if((coordenadas[i,3]<108) & (coordenadas[i,21]<5) & (simulhelper>umbralRAM)){   #RAM PD- cells divide if they are at PD and have doubled their size, if their division counter has not been surpassed (5max), and if they have threonine-catabolic products (Gly+Ile)
        if( (helper>=5) & (mod(helper,2)!=0)){
          coordenadas[i,6]<-1
        }else{coordenadas[i,6]<-0}
      }else{coordenadas[i,6]<-0}                                                        #RAM TD
    }                                    
    
    #2.- Compute cell displacements (how much a cell moves due to growth beneath it). 
    for(i in 1:id){ 
      ayuto<-findneighborsbelow(i,id,coordenadas)
      coordenadas[i,8]<-0
      if(ayuto[1]!=0){
        for(j in ayuto){
          if(coordenadas[j,6]==3){coordenadas[i,8]<-coordenadas[i,8]+El}
          else if(coordenadas[j,6]==0){coordenadas[i,8]<-coordenadas[i,8]+1}
        }}}
    
    #3.- Do divisions and growth: update coordenadas of the cells
    for(i in 1:id){  
      #Option1:Cells divide- id is the below daughter cell and i is the above one
      if(coordenadas[i,6]==1){   
        id<-id+1
        coordenadas[id,1]<-id
        coordenadas[id,2]<-coordenadas[i,2]+coordenadas[i,8] #Original position+cell displacement due to growth of beneath cells 
        coordenadas[id,3]<-coordenadas[i,2]+coordenadas[i,9]+coordenadas[i,8]  #Original position + half length mother cell + cell displacement due to growth of beneath cells 
        coordenadas[id,4]<-coordenadas[i,4]
        coordenadas[id,5]<-coordenadas[i,5]
        coordenadas[id,6]<-0
        if(coordenadas[i,2]==29){ #Stem cells divide asymmetrically, produce SC and RAM cells. The latter divide actively, the former divide rarely.
          celltype<-c(1,2,3,4,4,4,4,4,4,4,4,3,2,1) #epi,c,end,v,v,v,v,v,end,c,epi
          xpos<-c(15, 23, 28, 32, 34, 36, 38, 40, 42, 44, 46, 48, 52, 57)
          for(j in 1:length(xpos)){
            if(xpos[j]==coordenadas[i,4]){
              coordenadas[id,7]<-coordenadas[i,7]
              coordenadas[i,7]<-celltype[j]}
          }
        }else{
          coordenadas[id,7]<-coordenadas[i,7]}
        coordColors[id]<-coordColors[i]
        coordColors[i]<-sample(colores[,coordenadas[i,7]],1)
        coordenadas[i,2]<-coordenadas[id,3]+1
        coordenadas[i,3]<-coordenadas[i,2]+coordenadas[i,9]
        coordenadas[i,6]<-0
        if(coordenadas[id,2]==29){   
          coordenadas[id,21]<-0
          coordenadas[i,21]<-0}
        else{
          coordenadas[i,21]<-coordenadas[i,21]+1
          coordenadas[id,21]<-coordenadas[i,21]}
      }
      
      #Option2:Cells Grow
      else{
        #Cell elongation
        if(coordenadas[i,6]==3){
          coordenadas[i,2]<-coordenadas[i,2]+coordenadas[i,8]
          coordenadas[i,3]<-coordenadas[i,3]+coordenadas[i,8]+El
        }
        #No growth but displacement
        else if(coordenadas[i,6]==4){
          coordenadas[i,2]<- coordenadas[i,2]+coordenadas[i,8]
          coordenadas[i,3]<- coordenadas[i,3]+coordenadas[i,8]
        }
        #No growth but displacement- differentiation
        else if(coordenadas[i,6]==5){
          coordenadas[i,2]<- coordenadas[i,2]+coordenadas[i,8]
          coordenadas[i,3]<- coordenadas[i,3]+coordenadas[i,8]
        }
        #RAM growth
        else if(coordenadas[i,6]==0){
          coordenadas[i,2]<- coordenadas[i,2]+coordenadas[i,8]
          coordenadas[i,3]<- coordenadas[i,3]+coordenadas[i,8]+1
        }
      }
    }
    #########################################INTRACELLULAR DYNAMICS########################################
    #Cells compute their Thr,Gly and Ile levels using position-defined MTO2,TSY2,OMR1 and THA1/2 expression patterns (defined with linear functions, see Methods).  
    #ODE Thr biosynthesis and catabolism
    for(i in 1:id){
      if((simul!="WT") & (simul!="ts2")){
        coordenadas[i,15]<-0 
      }else{
        coordenadas[i,15]<-max(5,(-coordenadas[i,2])*0.5095+162.14)}  
      if((simul=="double mutant") | (simul=="ts2")){
        coordenadas[i,19]<-0  
      }else{
        coordenadas[i,19]<-max(0,(0.0118*coordenadas[i,2]+0.126)) }  
      if(coordenadas[i,2]>500){coordenadas[i,19]<-100} 
      coordenadas[i,16]<-max(0,(-0.0066*coordenadas[i,2]+3.1668))+max(0,(-0.0388*coordenadas[i,2]+8.5839))#THA1, THA2
      coordenadas[i,11]<-max(0,-0.037*coordenadas[i,2]+8.475) #OMR1
      parameters <- c(thetats1=thetats1,thetats2=thetats2,thetatha=thetatha,ts1=coordenadas[i,15],tha2=coordenadas[i,16],k=0.1,ts2=coordenadas[i,19],thetaomr1=thetaomr1,thetaile=thetaile,omr1=coordenadas[i,11],sustrate=100)
      state<-c(thr=coordenadas[i,17],gly=coordenadas[i,18],ile=coordenadas[i,20]) 
      times <-seq(0,10,by=.1)
      o <- ode(y=state,times=times,func=Op1NetworkCatabolism,parms=parameters) 
      coordenadas[i,17]<-o[101,2]#Thr
      coordenadas[i,18]<-o[101,3]#Gly
      coordenadas[i,20]<-o[101,4]#Ile
      coordColorsTS1[i]<-ts1[min(length(ts1),coordenadas[i,15]+1)]   #min function is used to set upper boundary in plot colors (given by length of color possibilities).
      coordColorsTHR[i]<-threonine[min(length(threonine),coordenadas[i,17]+1)]
      coordColorsTS2[i]<-ts2[min(length(ts2),coordenadas[i,19]*100+1)]
    }
    #########################################OUTPUT########################################
    write.table(coordenadas[1:id,],file=paste("output/",simul,"/",simul,"-time-",t,"a.u..csv",sep=""),sep=",",col.names = FALSE,row.names = FALSE)
    # plotField(coordenadas,t,coordColors,paste(simul,"-cells-time-"),x,y,simul)
  }
}

# Root growth curve
simulationTime<-simulationTime
growthcurveWT<-0
cont<-0
ticks<-0
name<-"output/"
for(i in 1:simulationTime){  
  if(mod(i,5)==0){
    a<-read.csv(paste(name,"WT/WT-time-",i,"a.u..csv",sep=""))
    cont<-cont+1
    ticks[cont]<-i/5
    growthcurveWT[cont]<-max(a[,2])}
}

growthcurvemto22<-0
cont<-0
for(i in 1:simulationTime){
  if(mod(i,5)==0){
    a<-read.csv(paste(name,"mto22/mto22-time-",i,"a.u..csv",sep=""))
    cont<-cont+1
    growthcurvemto22[cont]<-max(a[,2])}
}


coloress<-turbo(length(files))
pdf(paste(name,"rootgrowth.pdf",sep=""))#, width = 878, height = 630)
plot(ticks,growthcurveWT/4000,pch=19,ylab="Root length (a.u.)",xlab=("Time (a.u.)"),col=coloress[1])#,ylim=c(0,80))
lines(ticks,growthcurveWT/4000,col=coloress[1],lwd=3)
points(ticks,growthcurvemto22/4000,pch=19,col=coloress[2])
lines(ticks,growthcurvemto22/4000,col=coloress[2],lwd=2)
legend(1, max(growthcurveWT/4000), legend=files,pch=15, col=coloress,cex=1.5)
dev.off()